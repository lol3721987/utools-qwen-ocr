<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>慧眼识文</title>
  <script id="MathJax-script" async src="js/tex-mml-chtml.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }

    .container {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      width: 95%;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .panels-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .panel {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      height: 100%;
      position: relative;
      border: 2px solid #edf2f7;
      overflow: hidden;
    }

    .upload-panel {
      background: #f8fafc;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .upload-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      transition: opacity 0.3s ease;
    }

    #previewImage {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #previewImage.show {
      opacity: 1;
      display: block;
    }

    .upload-content.hide {
      opacity: 0;
      pointer-events: none;
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      color: #64748b;
    }

    .upload-text {
      color: #64748b;
      text-align: center;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .upload-text small {
      display: block;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #94a3b8;
    }

    .result-panel {
      background: #ffffff;
      position: relative;
    }

    .result-container {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
    }

    #result {
      width: 100%;
      height: auto;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.8;
      color: #334155;
      outline: none;
      min-height: 100px;
    }

    #result:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .buttons-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--panel-bg);
      border-radius: var(--radius-md);
      justify-content: flex-start;
      align-items: center;
      border-top: 1px solid var(--border-color);
    }

    .button-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      padding-right: 0.75rem;
      border-right: 1px solid var(--border-color);
    }

    .button-group:last-child {
      border-right: none;
      padding-right: 0;
      margin-left: auto;
    }

    .btn {
      position: relative;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      font-weight: 500;
      min-width: 90px;
      height: 34px;
      white-space: nowrap;
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .btn:hover svg {
      transform: scale(1.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #4338ca, #2563eb);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:active {
      box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:active {
      box-shadow: none;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .btn:hover::before {
      opacity: 1;
    }

    #loadingSpinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      width: 800px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 5rem 1.5rem; /* Add bottom padding to account for fixed footer */
      background: var(--bg-color, #ffffff);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
      position: relative; /* Add this to establish positioning context */
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color, rgba(0, 0, 0, 0.1));
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-color);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 1.5rem;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .settings-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .settings-section {
      background: var(--bg-color);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .settings-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #4f46e5, #6366f1);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .settings-section:hover::before {
      opacity: 1;
    }

    .settings-section:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .settings-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .settings-section-title svg {
      color: #6366f1;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.25rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-color);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .form-input:hover {
      border-color: #6366f1;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .form-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    textarea.form-input {
      min-height: 100px;
      resize: vertical;
    }

    .form-help {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      line-height: 1.4;
    }

    .radio-group {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      transition: all 0.2s ease;
      background: var(--bg-color);
      border: 1px solid transparent;
    }

    .radio-label:hover {
      background: var(--border-color);
      border-color: #6366f1;
    }

    .radio-label svg {
      color: #6366f1;
      transition: transform 0.2s ease;
    }

    .radio-label:hover svg {
      transform: scale(1.1);
    }

    .radio-label input[type="radio"] {
      appearance: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid var(--border-color);
      border-radius: 50%;
      margin: 0;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .radio-label input[type="radio"]:checked {
      border-color: #4f46e5;
      border-width: 2px;
    }

    .radio-label input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      width: 0.75rem;
      height: 0.75rem;
      background: #4f46e5;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      transition: transform 0.2s ease;
    }

    .radio-label:hover input[type="radio"] {
      border-color: #6366f1;
    }

    .modal-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-color, #ffffff);
      margin: 0;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      z-index: 10;
      width: 800px;
      max-width: 90%;
      border-radius: 0 0 20px 20px;
      transform: translateX(-50%);
      left: 50%;
    }

    @media (prefers-color-scheme: dark) {
      .modal-footer {
        background: #1e293b;
      }
    }

    @media (max-width: 768px) {
      .modal {
        padding: 1rem 1rem 5rem 1rem;
      }
      
      .modal-footer {
        padding: 1rem;
      }
    }

    .save-settings {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .save-settings:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }

    .save-settings:active {
      transform: translateY(0);
    }

    .save-settings::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .save-settings:hover::before {
      transform: translateX(100%);
    }

    @media (prefers-color-scheme: dark) {
      .modal {
        background: #1e293b;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      }

      .settings-section {
        background: #1e293b;
        border-color: #334155;
      }

      .settings-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .form-input {
        background: #1e293b;
        border-color: #334155;
        color: #f1f5f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .form-input:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .radio-label {
        background: #1e293b;
      }

      .radio-label:hover {
        background: rgba(99, 102, 241, 0.1);
      }

      .modal-close {
        background: #334155;
        color: #94a3b8;
      }

      .modal-close:hover {
        background: #475569;
        color: #f1f5f9;
      }
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      .modal {
        padding: 1rem;
      }

      .settings-section {
        padding: 1rem;
      }

      .radio-group {
        flex-direction: column;
        gap: 0.75rem;
      }

      .radio-label {
        padding: 0.75rem;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .buttons-container {
        padding: 0.75rem;
        gap: 0.75rem;
        flex-direction: column;
        align-items: stretch;
      }

      .button-group {
        width: 100%;
        padding-right: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
      }

      .button-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .btn {
        flex: 1;
      }

      .lang-select-container {
        flex: 1 1 100%;
        margin-left: 0;
        margin-top: 0.5rem;
      }

      .lang-select {
        width: 100%;
      }
    }

    /* Toast 通知样式 */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: #ffffff;
      color: #1e293b;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 300px;
      max-width: 500px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      pointer-events: none;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast.success {
      border-left: 4px solid #22c55e;
    }

    .toast.info {
      border-left: 4px solid #3b82f6;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    @media (prefers-color-scheme: dark) {
      .toast {
        background: #1e293b;
        color: #f1f5f9;
      }
    }

    /* 语言选择器样式 */
    .lang-select-container {
      display: flex;
      align-items: center;
      margin-left: auto;
      position: relative;
    }

    .lang-select {
      appearance: none;
      padding: 0.5rem 2rem 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--panel-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 38px;
      min-width: 120px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 12px;
    }

    .lang-select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .lang-select:hover {
      border-color: #4f46e5;
    }

    @media (max-width: 768px) {
      .buttons-container {
        padding: 0.75rem;
        gap: 0.75rem;
        flex-direction: column;
        align-items: stretch;
      }

      .button-group {
        width: 100%;
        padding-right: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
      }

      .button-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .btn {
        flex: 1;
      }

      .lang-select-container {
        flex: 1 1 100%;
        margin-left: 0;
        margin-top: 0.5rem;
      }

      .lang-select {
        width: 100%;
      }
    }

    /* 翻译按钮组合样式 */
    .translate-group {
      position: relative;
      display: inline-flex;
    }

    .translate-btn {
      position: relative;
      padding-right: 2rem !important;
      min-width: 90px !important;
    }

    .translate-toggle {
      position: absolute !important;
      right: 0;
      top: 0;
      bottom: 0;
      width: 1.75rem !important;
      min-width: auto !important;
      padding: 0 !important;
      border-left: 1px solid rgba(255, 255, 255, 0.15) !important;
      background: transparent !important;
      box-shadow: none !important;
    }

    .translate-toggle:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      transform: none !important;
    }

    .translate-toggle svg {
      width: 12px;
      height: 12px;
      margin: 0;
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .translate-toggle.active svg {
      transform: rotate(180deg);
    }

    .translate-dropdown {
      position: fixed;
      bottom: 100%;
      right: 20px;
      margin-bottom: 10px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 120px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(10px);
      visibility: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .translate-dropdown.show {
      opacity: 1;
      transform: translateY(0);
      visibility: visible;
    }

    @media (max-width: 768px) {
      .translate-dropdown {
        position: fixed;
        left: 20px;
        right: 20px;
        bottom: 80px;
      }
    }

    .translate-dropdown-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.15s ease;
      position: relative;
    }

    .translate-dropdown-item:hover {
      background: var(--bg-color);
    }

    .translate-dropdown-item.active {
      color: var(--primary-color);
      background: rgba(79, 70, 229, 0.08);
      font-weight: 500;
    }

    .translate-dropdown-item.active::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary-color);
    }

    @media (max-width: 768px) {
      .translate-group {
        width: 100%;
      }

      .translate-btn {
        flex: 1;
      }

      .translate-dropdown {
        width: 100%;
      }
    }

    /* 单选按钮组样式 */
    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      color: var(--text-primary);
    }

    .radio-label input[type="radio"] {
      appearance: none;
      width: 1.2rem;
      height: 1.2rem;
      border: 2px solid #4f46e5;
      border-radius: 50%;
      margin: 0;
      position: relative;
      cursor: pointer;
    }

    .radio-label input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      width: 0.7rem;
      height: 0.7rem;
      background: #4f46e5;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .radio-label:hover input[type="radio"] {
      border-color: #6366f1;
    }

    @media (prefers-color-scheme: dark) {
      .radio-label {
        color: #f1f5f9;
      }
    }

    /* 设置面板样式优化 */
    .settings-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .settings-container .form-group {
      margin-bottom: 0;
    }

    .settings-container .form-group.full-width {
      grid-column: 1 / -1;
    }

    .settings-divider {
      grid-column: 1 / -1;
      height: 1px;
      background: var(--border-color);
      margin: 0.5rem 0;
    }

    @media (max-width: 768px) {
      .settings-container {
        grid-template-columns: 1fr;
      }
    }

    .modal {
      width: 800px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
      background: var(--bg-color, #ffffff);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
    }

    .settings-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 1.5rem;
    }

    .settings-section {
      background: var(--bg-color);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .settings-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.25rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      outline: none;
    }

    .form-help {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    .radio-group {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .radio-label:hover {
      background: var(--border-color);
    }

    .radio-label input[type="radio"] {
      appearance: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid var(--border-color);
      border-radius: 50%;
      margin: 0;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .radio-label input[type="radio"]:checked {
      border-color: #4f46e5;
      border-width: 2px;
    }

    .radio-label input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      width: 0.75rem;
      height: 0.75rem;
      background: #4f46e5;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      transition: transform 0.2s ease;
    }

    .radio-label:hover input[type="radio"] {
      border-color: #6366f1;
    }

    .modal-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-color, #ffffff);
      margin: 0;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      z-index: 10;
      width: 800px;
      max-width: 90%;
      border-radius: 0 0 20px 20px;
      transform: translateX(-50%);
      left: 50%;
    }

    @media (prefers-color-scheme: dark) {
      .modal-footer {
        background: #1e293b;
      }
    }

    @media (max-width: 768px) {
      .modal {
        padding: 1rem 1rem 5rem 1rem;
      }
      
      .modal-footer {
        padding: 1rem;
      }
    }

    .save-settings {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .save-settings:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }

    .save-settings:active {
      transform: translateY(0);
    }

    .save-settings::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .save-settings:hover::before {
      transform: translateX(100%);
    }

    @media (prefers-color-scheme: dark) {
      .settings-section {
        background: #1e293b;
        border-color: #334155;
      }

      .form-input {
        background: #1e293b;
        border-color: #334155;
        color: #f1f5f9;
      }

      .form-input:hover {
        border-color: #6366f1;
      }

      .radio-label:hover {
        background: rgba(99, 102, 241, 0.1);
      }

      .modal-close {
        background: #334155;
        color: #94a3b8;
      }

      .modal-close:hover {
        background: #475569;
        color: #f1f5f9;
      }
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      .modal {
        padding: 1rem;
      }

      .settings-section {
        padding: 1rem;
      }

      .radio-group {
        flex-direction: column;
        gap: 0.75rem;
      }

      .radio-label {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panels-container">
      <div class="panel upload-panel" id="uploadArea">
        <div class="upload-content" id="uploadContent">
          <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <div class="upload-text" id="uploadText">
            拖拽图片到这里，或点击上传
            <small>支持复制粘贴图片</small>
          </div>
        </div>
        <img id="previewImage">
      </div>
      <div class="panel result-panel">
        <div class="result-container">
          <div id="result" contenteditable="true" spellcheck="false"></div>
          <div id="loadingSpinner"></div>
        </div>
      </div>
    </div>
    <div class="buttons-container">
      <!-- 系统功能组 -->
      <div class="button-group">
        <button class="btn btn-secondary" id="settingsBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
          </svg>
          插件设置
        </button>
        <button class="btn btn-secondary" id="clearBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
          </svg>
          一键清除
        </button>
      </div>

      <!-- OCR功能组 -->
      <div class="button-group">
        <button class="btn btn-primary" id="screenshotBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
            <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
          </svg>
          截图识别
        </button>
        <button class="btn btn-primary" id="retranslateBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
            <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
          </svg>
          重新识别
        </button>
      </div>

      <!-- 文本处理组 -->
      <div class="button-group">
        <button class="btn btn-primary" id="copyBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
          </svg>
          一键复制
        </button>
        <div class="translate-group">
          <button class="btn btn-primary translate-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
              <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z"/>
            </svg>
            翻译文本
          </button>
          <button class="btn btn-primary translate-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
            </svg>
          </button>
          <div class="translate-dropdown">
            <div class="translate-dropdown-item" data-lang="ZH">中文</div>
            <div class="translate-dropdown-item" data-lang="EN">英文</div>
            <div class="translate-dropdown-item" data-lang="JA">日语</div>
            <div class="translate-dropdown-item" data-lang="KO">韩语</div>
            <div class="translate-dropdown-item" data-lang="FR">法语</div>
            <div class="translate-dropdown-item" data-lang="DE">德语</div>
            <div class="translate-dropdown-item" data-lang="ES">西班牙语</div>
            <div class="translate-dropdown-item" data-lang="RU">俄语</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置面板 -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">插件设置</div>
        <button class="modal-close" id="closeSettings">&times;</button>
      </div>
      
      <div class="settings-container">
        <!-- 服务选择区域 -->
        <div class="settings-section">
          <h3 class="settings-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
              <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
            </svg>
            服务选择
          </h3>
          <div class="settings-grid">
            <div class="form-group">
              <label class="form-label">OCR 服务</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="ocrService" value="qwen" checked>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                  </svg>
                  通义千问
                </label>
                <label class="radio-label">
                  <input type="radio" name="ocrService" value="openai">
                  <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.0993 3.8558L12.6 8.3829 14.6201 7.2144a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.3927-.6813zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/>
                  </svg>
                  OpenAI
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">翻译服务</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="translationService" value="deeplx" checked>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
                    <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z"/>
                  </svg>
                  DeepLX
                </label>
                <label class="radio-label">
                  <input type="radio" name="translationService" value="openai">
                  <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.0993 3.8558L12.6 8.3829 14.6201 7.2144a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.3927-.6813zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/>
                  </svg>
                  OpenAI
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- 通义千问设置 -->
        <div class="settings-section">
          <h3 class="settings-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            通义千问设置
          </h3>
          <div class="form-group">
            <label class="form-label" for="apiToken">API Token</label>
            <input type="text" id="apiToken" class="form-input" placeholder="请输入您的 API Token，多个 Token 请用英文逗号分隔">
            <div class="form-help">多个Token请用英文逗号分隔，系统会随机选择一个使用</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="promptInput">OCR 自定义 Prompt</label>
            <textarea id="promptInput" class="form-input" rows="3" placeholder="可以自定义识别时的 Prompt，留空则使用默认设置"></textarea>
          </div>
        </div>

        <!-- DeepLX设置 -->
        <div class="settings-section">
          <h3 class="settings-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
              <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z"/>
            </svg>
            DeepLX 设置
          </h3>
          <div class="form-group">
            <label class="form-label" for="deeplxUrl">API URL</label>
            <input type="text" id="deeplxUrl" class="form-input" placeholder="请输入 DeepLX API 地址">
            <div class="form-help">DeepLX API 服务地址，例如：https://api.deeplx.org/XXXXXXXXXXXXXXXXXX/translate</div>
          </div>
        </div>

        <!-- OpenAI设置 -->
        <div class="settings-section">
          <h3 class="settings-section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.0993 3.8558L12.6 8.3829 14.6201 7.2144a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.3927-.6813zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/>
            </svg>
            OpenAI 设置
          </h3>
          <div class="settings-grid">
            <div class="form-group">
              <label class="form-label" for="openaiUrl">API URL</label>
              <input type="text" id="openaiUrl" class="form-input" placeholder="请输入 OpenAI API 地址">
              <div class="form-help">OpenAI API 服务地址，例如：https://api.openai.com</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="openaiToken">API Token</label>
              <input type="text" id="openaiToken" class="form-input" placeholder="请输入 OpenAI API Token">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="openaiModel">模型选择</label>
            <input type="text" id="openaiModel" class="form-input" placeholder="请输入模型名称，例如：gpt-4-vision-preview" value="gpt-4-vision-preview">
            <div class="form-help">OCR 需要使用支持图片识别的模型，如：gpt-4-vision-preview</div>
          </div>
        </div>

        <!-- 翻译设置 -->
        <div class="settings-section">
          <h3 class="settings-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
              <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z"/>
            </svg>
            翻译设置
          </h3>
          <div class="form-group">
            <label class="form-label" for="translatePrompt">翻译 Prompt</label>
            <textarea id="translatePrompt" class="form-input" rows="3" placeholder="可以自定义翻译时的 Prompt，留空则使用默认设置"></textarea>
            <div class="form-help">自定义翻译时的 Prompt，可以使用 {{text}} 作为占位符表示要翻译的文本，{{lang}} 作为目标语言占位符</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="save-settings" id="saveSettings">保存设置</button>
      </div>
    </div>
  </div>

  <!-- Toast 通知容器 -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // 等待 preload.js 加载完成
    window.onload = () => {
      if (!window.services) {
        console.error('Services not initialized. Please check if preload.js is loaded correctly.');
        alert('插件初始化失败，请检查开发者工具中的错误信息');
        return;
      }

      // 初始化变量
      const uploadArea = document.getElementById('uploadArea');
      const uploadText = document.getElementById('uploadText');
      const resultDiv = document.getElementById('result');
      const previewImage = document.getElementById('previewImage');
      const copyBtn = document.getElementById('copyBtn');
      const retranslateBtn = document.getElementById('retranslateBtn');
      const settingsModal = document.getElementById('settingsModal');
      const settingsBtn = document.getElementById('settingsBtn');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings = document.getElementById('saveSettings');
      const apiToken = document.getElementById('apiToken');
      const promptInput = document.getElementById('promptInput');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const clearBtn = document.getElementById('clearBtn');
      const screenshotBtn = document.getElementById('screenshotBtn');
      const deeplxUrl = document.getElementById('deeplxUrl');
      const openaiUrl = document.getElementById('openaiUrl');
      const openaiToken = document.getElementById('openaiToken');
      const openaiModel = document.getElementById('openaiModel');
      const translatePrompt = document.getElementById('translatePrompt');
      const translationServiceRadios = document.getElementsByName('translationService');
      
      // 翻译相关元素
      const translateGroup = document.querySelector('.translate-group');
      const translateBtn = document.querySelector('.translate-btn');
      const translateDropdown = document.querySelector('.translate-dropdown');
      const translateItems = document.querySelectorAll('.translate-dropdown-item');
      const translateToggle = document.querySelector('.translate-toggle');
      let currentLang = 'ZH';

      let currentImageData = null;
      let currentOcrText = null;

      // Toast 通知功能
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // 根据类型选择图标
        let icon = '';
        switch(type) {
          case 'error':
            icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>';
            break;
          case 'success':
            icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>';
            break;
          default:
            icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>';
        }
        
        toast.innerHTML = `${icon}<span>${message}</span>`;
        
        document.getElementById('toastContainer').appendChild(toast);
        
        // 3秒后移除
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // 从本地存储加载设置
      function loadSettings() {
        const settings = window.services.getSettings();
        if (!settings) return;

        // 安全地设置值的辅助函数
        const safeSetValue = (element, value) => {
          if (element) element.value = value;
        };

        safeSetValue(apiToken, settings.tokens.join(','));
        safeSetValue(promptInput, settings.prompt || '');
        safeSetValue(deeplxUrl, settings.deeplxUrl || '');
        safeSetValue(openaiUrl, settings.openaiUrl || '');
        safeSetValue(openaiToken, settings.openaiToken || '');
        safeSetValue(openaiModel, settings.openaiModel || 'gpt-4-vision-preview');
        safeSetValue(translatePrompt, settings.translatePrompt || '');

        // 设置翻译服务
        const translationService = settings.translationService || 'deeplx';
        const ocrService = settings.ocrService || 'qwen';

        // 设置翻译服务单选按钮
        if (translationServiceRadios) {
          Array.from(translationServiceRadios).forEach(radio => {
            if (radio) radio.checked = radio.value === translationService;
          });
        }

        // 设置 OCR 服务单选按钮
        const ocrServiceRadios = document.getElementsByName('ocrService');
        if (ocrServiceRadios) {
          Array.from(ocrServiceRadios).forEach(radio => {
            if (radio) radio.checked = radio.value === ocrService;
          });
        }

        // 设置当前语言
        currentLang = settings.targetLang || 'ZH';
        
        // 更新语言选择器的选中状态
        if (translateItems) {
          translateItems.forEach(item => {
            if (item && item.dataset.lang === currentLang) {
              item.classList.add('active');
            } else if (item) {
              item.classList.remove('active');
            }
          });
        }
      }

      // 保存设置到本地存储
      function saveSettingsToStorage() {
        try {
          const selectedTranslationService = document.querySelector('input[name="translationService"]:checked');
          const selectedOcrService = document.querySelector('input[name="ocrService"]:checked');
          const translationService = selectedTranslationService ? selectedTranslationService.value : 'deeplx';
          const ocrService = selectedOcrService ? selectedOcrService.value : 'qwen';

          // 安全地获取值的辅助函数
          const safeGetValue = (elementId) => {
            const element = document.getElementById(elementId);
            return element ? element.value.trim() : '';
          };

          const settings = {
            tokens: safeGetValue('apiToken'),
            prompt: safeGetValue('promptInput'),
            deeplxUrl: safeGetValue('deeplxUrl'),
            openaiUrl: safeGetValue('openaiUrl'),
            openaiToken: safeGetValue('openaiToken'),
            openaiModel: safeGetValue('openaiModel') || 'gpt-4-vision-preview',
            translationService: translationService,
            ocrService: ocrService,
            targetLang: currentLang || 'ZH',
            translatePrompt: safeGetValue('translatePrompt')
          };

          window.services.saveSettings(settings);
          if (settingsModal) settingsModal.classList.remove('show');
          showToast('设置已保存', 'success');
        } catch (error) {
          console.error('保存设置失败:', error);
          showToast('保存设置失败: ' + error.message, 'error');
        }
      }

      // 翻译功能
      async function translateText() {
        // 使用当前编辑后的文本而不是 OCR 原始文本
        const textToTranslate = resultDiv.textContent || '';
        
        if (!textToTranslate.trim()) {
          showToast('请先进行OCR识别或输入文本', 'error');
          return;
        }

        const settings = window.services.getSettings();
        const service = settings.translationService || 'deeplx';

        if (service === 'deeplx' && !settings.deeplxUrl) {
          showToast('请先设置DeepLX API地址', 'error');
          settingsModal.classList.add('show');
          return;
        }

        if (service === 'openai' && (!settings.openaiUrl || !settings.openaiToken)) {
          showToast('请先设置OpenAI API配置', 'error');
          settingsModal.classList.add('show');
          return;
        }

        loadingSpinner.style.display = 'block';
        try {
          let translatedText;
          
          if (service === 'deeplx') {
            const response = await fetch(settings.deeplxUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                text: textToTranslate,
                source_lang: 'AUTO',
                target_lang: currentLang
              }),
            });

            if (!response.ok) {
              throw new Error('翻译请求失败');
            }

            const data = await response.json();
            if (data.code === 200 && data.data) {
              translatedText = data.data;
            } else {
              throw new Error(data.message || '翻译失败');
            }
          } else if (service === 'openai') {
            translatedText = await window.services.callOpenAIAPI(textToTranslate, currentLang);
          }

          resultDiv.innerHTML = translatedText;
          // 如果有数学公式，重新渲染
          MathJax.typesetPromise([resultDiv]);
          showToast(`使用 ${service === 'deeplx' ? 'DeepLX' : 'OpenAI'} 翻译完成`, 'success');
        } catch (error) {
          console.error('Translation error:', error);
          showToast(`翻译失败: ${error.message}`, 'error');
        } finally {
          loadingSpinner.style.display = 'none';
        }
      }

      // 处理图片识别
      async function processImage(imageData) {
        if (!imageData) return;
        
        const settings = window.services.getSettings();
        const service = settings.ocrService || 'qwen';

        if (service === 'qwen' && !window.services.getRandomToken()) {
          showToast('请先设置通义千问 API Token', 'error');
          settingsModal.classList.add('show');
          return;
        }

        if (service === 'openai' && (!settings.openaiUrl || !settings.openaiToken)) {
          showToast('请先设置OpenAI API配置', 'error');
          settingsModal.classList.add('show');
          return;
        }

        currentImageData = imageData;
        
        // 显示图片预览并隐藏提示文字
        previewImage.src = imageData;
        previewImage.classList.add('show');
        document.getElementById('uploadContent').classList.add('hide');
        resultDiv.innerHTML = '';
        loadingSpinner.style.display = 'block';

        try {
          let result;

          if (service === 'qwen') {
            // 通义千问 OCR 处理
            const token = window.services.getRandomToken();
            const imagePath = window.services.saveTempImage(imageData);
            const formData = new FormData();
            formData.append('file', await fetch(imagePath).then(r => r.blob()));

            const uploadResponse = await fetch('https://chat.qwenlm.ai/api/v1/files/', {
              method: 'POST',
              headers: {
                'accept': 'application/json',
                'authorization': `Bearer ${token}`,
              },
              body: formData,
            });

            const uploadData = await uploadResponse.json();
            if (!uploadData.id) throw new Error('文件上传失败');

            const prompt = promptInput.value.trim() || '请识别图片中的内容。对于数学公式和数学符号，请使用标准的LaTeX格式输出。' +
                          '要求：\n' +
                          '1. 所有数学公式和单个数学符号都要用LaTeX格式\n' +
                          '2. 普通文本保持原样\n' +
                          '3. 严格保持原文的段落格式和换行，不需要输出具体的换行符\\n，只需保持原文的样式\n' +
                          '4. 对于代码块，请使用 markdown 格式输出，使用```包裹代码块';

            const recognizeResponse = await fetch('https://chat.qwenlm.ai/api/chat/completions', {
              method: 'POST',
              headers: {
                'accept': '*/*',
                'authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                stream: false,
                model: 'qwen-vl-max-latest',
                messages: [
                  {
                    role: 'user',
                    content: [
                      { type: 'text', text: prompt },
                      { type: 'image', image: uploadData.id },
                    ],
                  },
                ],
                session_id: '1',
                chat_id: '2',
                id: '3',
              }),
            });

            const recognizeData = await recognizeResponse.json();
            result = recognizeData.choices[0]?.message?.content || '识别失败';

          } else if (service === 'openai') {
            // OpenAI OCR 处理
            const imagePath = window.services.saveTempImage(imageData);
            const imageBase64 = imageData.split(',')[1];

            const prompt = promptInput.value.trim() || '请识别图片中的内容。对于数学公式和数学符号，请使用标准的LaTeX格式输出。' +
                          '要求：\n' +
                          '1. 所有数学公式和单个数学符号都要用LaTeX格式\n' +
                          '2. 普通文本保持原样\n' +
                          '3. 严格保持原文的段落格式和换行，不需要输出具体的换行符\\n，只需保持原文的样式\n' +
                          '4. 对于代码块，请使用 markdown 格式输出，使用```包裹代码块';

            const response = await fetch(settings.openaiUrl + '/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${settings.openaiToken}`,
              },
              body: JSON.stringify({
                model: settings.openaiModel || 'gpt-4-vision-preview',
                messages: [
                  {
                    role: 'user',
                    content: [
                      { type: 'text', text: prompt },
                      {
                        type: 'image_url',
                        image_url: {
                          url: `data:image/jpeg;base64,${imageBase64}`,
                        },
                      },
                    ],
                  },
                ],
                max_tokens: 4096,
              }),
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error?.message || '识别失败');
            }

            const data = await response.json();
            result = data.choices[0]?.message?.content || '识别失败';
          }

          currentOcrText = result;

          // 处理结果
          resultDiv.innerHTML = result
            .replace(/\\（/g, '\\(')
            .replace(/\\）/g, '\\)')
            .replace(/\n{3,}/g, '\n\n')
            .replace(/([^\n])\n([^\n])/g, '$1\n$2')
            .trim();

          // 渲染数学公式
          MathJax.typesetPromise([resultDiv]);

        } catch (error) {
          showToast(`处理失败: ${error.message}`, 'error');
          resultDiv.textContent = '';
        } finally {
          loadingSpinner.style.display = 'none';
        }
      }

      // 将处理函数暴露到全局，供 preload.js 调用
      window.processPluginImage = processImage;

      // 文件拖放处理
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            processImage(e.target.result);
          };
          reader.readAsDataURL(file);
        }
      });

      // 点击上传
      uploadArea.addEventListener('click', () => {
        const result = window.utools.showOpenDialog({
          filters: [{ name: '图片文件', extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp'] }],
          properties: ['openFile']
        });
        
        if (result && result.length > 0) {
          const imagePath = result[0];
          const imageData = window.services.readImageAsBase64(imagePath);
          processImage(imageData);
        }
      });

      // 粘贴处理
      document.addEventListener('paste', (e) => {
        const file = e.clipboardData.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            processImage(e.target.result);
          };
          reader.readAsDataURL(file);
        }
      });

      // 复制结果功能
      copyBtn.addEventListener('click', () => {
        const result = resultDiv.textContent;
        window.services.copyToClipboard(result);
        copyBtn.textContent = '已复制';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.textContent = '一键复制';
          copyBtn.classList.remove('copied');
        }, 2000);
      });

      // 重新识别功能
      retranslateBtn.addEventListener('click', () => {
        if (currentImageData) {
          resultDiv.innerHTML = '';
          loadingSpinner.style.display = 'block';
          processImage(currentImageData).finally(() => {
            loadingSpinner.style.display = 'none';
          });
        }
      });

      // 打开设置面板
      settingsBtn.addEventListener('click', () => {
        loadSettings();
        settingsModal.classList.add('show');
      });

      // 关闭设置面板
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('show');
      });

      // 点击遮罩层关闭
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('show');
        }
      });

      // 保存设置
      saveSettings.addEventListener('click', saveSettingsToStorage);

      // 一键清除功能
      clearBtn.addEventListener('click', () => {
        currentImageData = null;
        previewImage.src = '';
        previewImage.classList.remove('show');
        document.getElementById('uploadContent').classList.remove('hide');
        resultDiv.innerHTML = '';
      });

      // 初始化时加载设置
      loadSettings();

      // 截图功能
      screenshotBtn.addEventListener('click', () => {
        // 最小化窗口，以免影响截图
        window.utools.hideMainWindow();
        // 延迟一小段时间，确保窗口已经隐藏
        setTimeout(() => {
          // 调用截图
          window.utools.screenCapture((imageData) => {
            // 如果有截图结果，显示主窗口并处理图片
            if (imageData) {
              window.utools.showMainWindow();
              processImage(imageData);
            } else {
              // 如果用户取消截图，也显示主窗口
              window.utools.showMainWindow();
            }
          });
        }, 100);
      });

      // 初始化选中状态
      translateItems[0].classList.add('active');

      // 点击翻译按钮
      translateBtn.addEventListener('click', async () => {
        // 使用当前编辑框中的文本而不是 OCR 文本
        const textToTranslate = resultDiv.textContent || '';
        
        if (!textToTranslate.trim()) {
          showToast('请先进行OCR识别或输入文本', 'error');
          return;
        }

        const settings = window.services.getSettings();
        const service = settings.translationService || 'deeplx';

        if (service === 'deeplx' && !settings.deeplxUrl) {
          showToast('请先设置DeepLX API地址', 'error');
          settingsModal.classList.add('show');
          return;
        }

        if (service === 'openai' && (!settings.openaiUrl || !settings.openaiToken)) {
          showToast('请先设置OpenAI API配置', 'error');
          settingsModal.classList.add('show');
          return;
        }

        loadingSpinner.style.display = 'block';
        try {
          let translatedText;
          
          if (service === 'deeplx') {
            const response = await fetch(settings.deeplxUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                text: textToTranslate,
                source_lang: 'AUTO',
                target_lang: currentLang
              }),
            });

            if (!response.ok) {
              throw new Error('翻译请求失败');
            }

            const data = await response.json();
            if (data.code === 200 && data.data) {
              translatedText = data.data;
            } else {
              throw new Error(data.message || '翻译失败');
            }
          } else if (service === 'openai') {
            translatedText = await window.services.callOpenAIAPI(textToTranslate, currentLang);
          }

          resultDiv.innerHTML = translatedText;
          // 如果有数学公式，重新渲染
          MathJax.typesetPromise([resultDiv]);
          showToast(`使用 ${service === 'deeplx' ? 'DeepLX' : 'OpenAI'} 翻译完成`, 'success');
        } catch (error) {
          console.error('Translation error:', error);
          showToast(`翻译失败: ${error.message}`, 'error');
        } finally {
          loadingSpinner.style.display = 'none';
        }
      });

      // 点击语言选项
      translateItems.forEach(item => {
        item.addEventListener('click', () => {
          translateItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          currentLang = item.dataset.lang;
          translateDropdown.classList.remove('show');
          translateToggle.classList.remove('active');
        });
      });

      // 点击下拉按钮和点击外部关闭
      document.addEventListener('click', (e) => {
        if (e.target.closest('.translate-toggle')) {
          const translateBtn = document.querySelector('.translate-btn');
          const btnRect = translateBtn.getBoundingClientRect();
          const dropdown = document.querySelector('.translate-dropdown');
          
          // 设置下拉菜单位置
          dropdown.style.bottom = (window.innerHeight - btnRect.top + 10) + 'px';
          dropdown.style.right = (window.innerWidth - btnRect.right) + 'px';
          
          dropdown.classList.toggle('show');
          translateToggle.classList.toggle('active');
        } else if (!e.target.closest('.translate-dropdown')) {
          translateDropdown.classList.remove('show');
          translateToggle.classList.remove('active');
        }
      });

      // uTools 插件入口
      window.exports = {
        'qwen_ocr': {
          mode: 'none',
          args: {
            enter: (action) => {
              // 如果是拖拽或选择的图片
              if (action.type === 'img') {
                const imagePath = action.payload[0];
                const imageData = window.services.readImageAsBase64(imagePath);
                processImage(imageData);
              }
            }
          }
        }
      }
    };
  </script>
</body>
</html> 